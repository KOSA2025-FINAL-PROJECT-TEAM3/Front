// SilverCare Database Schema - Version C
// Complete ERD designed from PROJECT_SPECIFICATION.md + FRONTEND_COMPONENTS_SPECIFICATION.md
// dbdiagram.io용 DBML
//
// 작성일: 2025-11-10
// 목적: 3-way comparison용 완전한 데이터베이스 설계
// 테이블 수: 26개 (모든 기능 포함)

Project SilverCare_V3 {
  database_type: 'PostgreSQL'
  Note: '''
    # 실버케어 - 가족 돌봄 중심 약 관리 플랫폼

    ## Core Features (PROJECT_SPECIFICATION.md)
    ✅ 가족 돌봄 네트워크 (실시간 Hocuspocus 동기화)
    ✅ 약-음식 충돌 경고 (50-100개 상호작용)
    ✅ OCR 처방전 스캔 (Google Vision + Tesseract)
    ✅ 알약 역검색 (식약처 API)
    ✅ 복약 순응도 리포트 (PDF 다운로드)
    ✅ 의사/AI 챗봇 상담 (WebSocket)
    ✅ 증상 검색 & AI 진단
    ✅ 질병 관리 (질병별 제한사항)

    ## Authentication
    - Kakao OAuth (primary)
    - JWT token (Access 15분, Refresh 7일)
    - Multi-device support

    ## Frontend Pages Support
    - 34 pages from FRONTEND_COMPONENTS_SPECIFICATION.md
    - 모든 페이지에 대한 데이터베이스 지원
  '''
}

// ================================================
// 1. 사용자 인증 및 권한 (Authentication & Authorization)
// ================================================

Table users {
  id bigint [pk, increment]
  
  // 기본 정보
  email varchar(255) [unique, not null]
  password_hash varchar(255) [null, note: 'NULL for OAuth-only users']
  name varchar(100) [not null]
  phone varchar(20) [unique]
  birth_date date
  gender varchar(10) [note: 'male | female | other']
  profile_image_url text
  
  // 역할 (RoleSelectionPage)
  role varchar(20) [not null, default: 'senior', note: 'senior | caregiver']
  
  // Kakao OAuth (KakaoLoginPage)
  kakao_id varchar(100) [unique, note: 'Kakao OAuth user ID']
  kakao_email varchar(255)
  kakao_profile_image text
  kakao_connected_at timestamp
  kakao_access_token text [note: 'Encrypted']
  kakao_refresh_token text [note: 'Encrypted']
  
  // 계정 상태
  is_active boolean [default: true]
  email_verified boolean [default: false]
  phone_verified boolean [default: false]
  
  // 알림 설정 (NotificationSettingsPage)
  notification_medication boolean [default: true]
  notification_diet_warning boolean [default: true]
  notification_family boolean [default: true]
  notification_system boolean [default: true]
  
  // 타임스탬프
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  last_login_at timestamp
  
  Indexes {
    email
    kakao_id
    phone
    (role, is_active)
  }
  
  Note: 'KakaoLoginPage, RoleSelectionPage, ProfileEditPage'
}

Table oauth_providers {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  
  provider varchar(50) [not null, note: 'kakao | google | naver']
  provider_user_id varchar(255) [not null, note: 'Provider의 고유 ID']
  provider_email varchar(255)
  
  access_token text [note: 'AES-256 encrypted']
  refresh_token text [note: 'AES-256 encrypted']
  token_expires_at timestamp
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    (provider, provider_user_id) [unique]
    user_id
  }
  
  Note: '다중 OAuth 제공자 지원 (확장 가능)'
}

Table refresh_tokens {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  
  token_hash varchar(255) [unique, not null, note: 'SHA-256 hashed']
  device_id varchar(255)
  device_name varchar(100)
  user_agent text
  ip_address varchar(45)
  
  expires_at timestamp [not null]
  created_at timestamp [default: `now()`]
  revoked_at timestamp [null, note: '로그아웃 시 revoke']
  
  Indexes {
    token_hash
    user_id
    (user_id, revoked_at)
    expires_at
  }
  
  Note: 'JWT Refresh Token 관리 (7일 유효, 멀티 디바이스)'
}

// ================================================
// 2. 가족 네트워크 (Family Care Network)
// ================================================

Table family_groups {
  id bigint [pk, increment]
  
  name varchar(100) [not null, note: '가족 그룹 이름']
  description text
  created_by bigint [ref: > users.id, not null]
  
  // Hocuspocus 실시간 동기화 키
  sync_document_id varchar(255) [unique, note: 'family-group-{id}']
  
  // 그룹 설정
  invite_code varchar(20) [unique, note: '초대 코드 (6자리)']
  invite_code_expires_at timestamp
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    created_by
    sync_document_id
    invite_code
  }
  
  Note: 'FamilyManagementPage - 가족 그룹 (실시간 동기화 단위)'
}

Table family_members {
  id bigint [pk, increment]
  family_group_id bigint [ref: > family_groups.id, not null]
  user_id bigint [ref: > users.id, not null]
  
  // 가족 내 역할
  member_role varchar(20) [not null, note: 'parent | child | caregiver']
  nickname varchar(50) [note: '가족 내 별칭']
  
  // 권한 (세분화)
  can_edit_medications boolean [default: false]
  can_view_health_data boolean [default: true]
  can_receive_alerts boolean [default: true]
  can_manage_family boolean [default: false]
  
  // 초대 상태
  invitation_status varchar(20) [default: 'pending', note: 'pending | accepted | declined']
  invited_by bigint [ref: > users.id]
  invited_at timestamp
  joined_at timestamp
  left_at timestamp
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    family_group_id
    user_id
    (family_group_id, user_id) [unique]
    invitation_status
  }
  
  Note: 'FamilyManagementPage, FamilyMemberDetailPage - 가족 구성원 (N:M)'
}

// ================================================
// 3. 약 관리 (Medication Management)
// ================================================

Table medications {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  
  // 약품 정보
  name varchar(255) [not null]
  ingredient varchar(255) [note: '주성분 (예: Amlodipine)']
  manufacturer varchar(255) [note: '제조사']
  item_seq varchar(50) [note: '식약처 품목기준코드']
  
  // 용량 및 복용
  dosage varchar(100) [note: '5mg, 10mg 등']
  dosage_amount varchar(50) [note: '1정, 2정 등']
  timing json [note: '["아침 식후", "저녁 식후"] 등']
  frequency varchar(100) [note: '하루 1회, 하루 3회 등']
  
  // 복용 기간
  start_date date [not null]
  end_date date
  
  // 재고 관리 (InventoryTracker)
  total_quantity int [note: '총 수량']
  remaining_quantity int [note: '남은 수량']
  low_stock_threshold int [default: 7, note: '재고 부족 알림 기준']
  expiry_date date [note: '유효기간']
  
  // 이미지
  image_url text [note: '약품 이미지']
  
  // 메타데이터
  warnings json [note: '주의사항 배열']
  side_effects json [note: '부작용 정보']
  interactions json [note: '상호작용 정보']
  storage_method text [note: '보관 방법']
  notes text [note: '사용자 메모']
  
  // OCR 연동
  ocr_record_id bigint [ref: > ocr_records.id, note: 'OCR로 등록된 경우']
  
  // 상태
  is_active boolean [default: true]
  is_critical boolean [default: false, note: '중요 약물 표시']
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    (user_id, is_active)
    name
    ingredient
    item_seq
    start_date
    end_date
    expiry_date
  }
  
  Note: 'MedicationListPage, MedicationDetailPage, MedicationAddPage'
}

Table medication_schedules {
  id bigint [pk, increment]
  medication_id bigint [ref: > medications.id, not null]
  
  // 스케줄 정보
  time time [not null, note: '복용 시간 (예: 08:00)']
  days_of_week json [note: '[0,1,2,3,4,5,6] 일요일=0, null이면 매일']
  timing varchar(50) [note: '식전 | 식후 30분 | 기상 시 | 취침 전']
  dosage_amount varchar(50) [note: '1회 복용량']
  
  // 알림 설정
  reminder_enabled boolean [default: true]
  reminder_minutes_before int [default: 0, note: '복용 N분 전 알림']
  reminder_repeat_interval int [default: 30, note: '미복용 시 N분마다 재알림']
  reminder_max_repeats int [default: 3, note: '최대 재알림 횟수']
  
  // 상태
  is_active boolean [default: true]
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    medication_id
    (medication_id, is_active)
    time
  }
  
  Note: 'MedicationScheduleTimeline - 약 복용 스케줄 (반복 일정)'
}

Table medication_logs {
  id bigint [pk, increment]
  medication_id bigint [ref: > medications.id, not null]
  user_id bigint [ref: > users.id, not null]
  schedule_id bigint [ref: > medication_schedules.id]
  
  // 복용 정보
  scheduled_time timestamp [not null, note: '예정 복용 시간']
  completed_time timestamp [note: '실제 복용 시간']
  
  // 상태
  status varchar(20) [not null, default: 'pending', note: 'pending | completed | missed | skipped']
  
  // 메모
  notes text [note: '복용 시 메모']
  side_effects_noted text [note: '부작용 기록']
  photo_url text [note: '복용 인증 사진']
  
  // 가족 동기화 (Hocuspocus)
  confirmed_by bigint [ref: > users.id, note: '확인한 가족 구성원']
  confirmed_at timestamp
  
  // 위치 정보 (선택)
  location_lat decimal(10, 8)
  location_lng decimal(11, 8)
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    medication_id
    user_id
    schedule_id
    scheduled_time
    status
    (user_id, scheduled_time)
    (medication_id, status, scheduled_time)
  }
  
  Note: 'TodayMedicationChecklist - 복약 기록 (실시간 가족 동기화)'
}

Table medication_reviews {
  id bigint [pk, increment]
  medication_id bigint [ref: > medications.id, not null]
  user_id bigint [ref: > users.id, not null]
  
  // 리뷰 내용
  rating int [not null, note: '1-5점']
  review_title varchar(255)
  review_content text [not null]
  
  // 효과 및 부작용
  effectiveness int [note: '1-5점, 약 효과']
  side_effects_severity int [note: '1-5점, 부작용 정도']
  side_effects_description text
  
  // 추천 여부
  would_recommend boolean
  
  // 통계
  helpful_count int [default: 0]
  reported_count int [default: 0]
  
  // 상태
  is_verified_purchase boolean [default: false, note: '실제 복용 여부']
  is_visible boolean [default: true]
  moderated_at timestamp
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    medication_id
    user_id
    rating
    (medication_id, is_visible, created_at)
  }
  
  Note: 'MedicationReviewsPage - 약물 리뷰 (커뮤니티 기능)'
}

// ================================================
// 4. 약-음식 상호작용 (Drug-Food Interactions)
// ================================================

Table drug_food_interactions {
  id bigint [pk, increment]
  
  // 약물 정보
  drug_name varchar(255) [not null]
  drug_ingredient varchar(255) [note: '주성분 (예: Warfarin)']
  drug_category varchar(100) [note: '항응고제, 혈압약, 당뇨약 등']
  
  // 음식 정보
  food_name varchar(255) [not null]
  food_category varchar(100) [note: '채소, 과일, 유제품 등']
  conflict_ingredient varchar(255) [note: '충돌 성분 (예: 비타민K)']
  
  // 상호작용 상세
  reason text [not null, note: '상호작용 이유']
  mechanism text [note: '작용 메커니즘']
  severity varchar(20) [not null, note: '높음 | 중간 | 낮음']
  
  // 권장사항
  alternatives json [note: '대체 음식 배열']
  recommendations text [note: '복용 시 권장사항']
  
  // 출처 및 신뢰도
  source varchar(500) [note: '식약처, FDA, 병원 등']
  evidence_level varchar(20) [note: 'high | medium | low']
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    drug_name
    drug_ingredient
    food_name
    severity
    (drug_name, food_name)
  }
  
  Note: 'FoodConflictWarning - 약-음식 충돌 DB (50-100개 주요 상호작용)'
}

// ================================================
// 5. 식단 관리 (Diet Management)
// ================================================

Table diet_logs {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  
  // 식사 정보
  meal_type varchar(20) [not null, note: 'breakfast | lunch | dinner | snack']
  food_name varchar(255) [not null]
  food_category varchar(100)
  quantity varchar(100) [note: '양 (선택)']
  
  // 영양 정보 (선택)
  calories int [note: '칼로리']
  carbohydrates decimal(5,2) [note: '탄수화물 (g)']
  protein decimal(5,2) [note: '단백질 (g)']
  fat decimal(5,2) [note: '지방 (g)']
  
  // 시간
  meal_time timestamp [not null]
  
  // 이미지
  photo_url text [note: '식사 사진']
  
  // 메모
  notes text
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    meal_time
    meal_type
    (user_id, meal_time)
  }
  
  Note: 'DietLogPage - 사용자 식단 기록'
}

Table diet_warnings {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  diet_log_id bigint [ref: > diet_logs.id, not null]
  medication_id bigint [ref: > medications.id, not null]
  interaction_id bigint [ref: > drug_food_interactions.id]
  
  // 경고 정보
  warning_message text [not null]
  severity varchar(20) [not null]
  alternatives json [note: '대체 음식 제안']
  recommendations text
  
  // 사용자 반응
  user_acknowledged boolean [default: false]
  acknowledged_at timestamp
  user_feedback text [note: '사용자 피드백']
  
  // 가족 알림
  family_notified boolean [default: false, note: 'severity=높음 시 가족에게 알림']
  notified_at timestamp
  notified_members json [note: '알림받은 가족 구성원 ID 배열']
  
  created_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    diet_log_id
    medication_id
    severity
    (user_id, created_at)
  }
  
  Note: 'FoodWarningPage - 약-음식 충돌 경고 기록'
}

Table hospital_diet_resources {
  id bigint [pk, increment]
  
  // 병원 정보
  hospital_name varchar(255) [not null]
  hospital_type varchar(100) [note: '대학병원, 종합병원 등']
  
  // 리소스 정보
  resource_title varchar(255) [not null]
  resource_category varchar(100) [note: '당뇨, 고혈압, 신장질환 등']
  resource_type varchar(50) [note: 'pdf | web | video']
  resource_url text [not null]
  
  // 콘텐츠
  description text
  thumbnail_url text
  
  // 메타데이터
  published_date date
  author varchar(255)
  tags json [note: '검색 태그 배열']
  
  // 통계
  view_count int [default: 0]
  download_count int [default: 0]
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    resource_category
    hospital_name
    published_date
  }
  
  Note: 'HospitalDietResourcesPage - 병원 공식 식단 자료'
}

// ================================================
// 6. 질병 관리 (Disease Management)
// ================================================

Table disease_info {
  id bigint [pk, increment]
  
  // 질병 정보
  disease_name varchar(255) [not null, unique]
  disease_code varchar(50) [unique, note: 'ICD-10 코드 (예: E11 - 제2형 당뇨병)']
  disease_name_en varchar(255) [note: '영문명']
  
  // 분류
  category varchar(100) [note: '만성질환, 급성질환 등']
  severity varchar(20) [note: '경증 | 중증']
  
  // 상세 정보
  description text
  symptoms json [note: '주요 증상 배열']
  causes json [note: '원인 배열']
  risk_factors json [note: '위험 요인']
  
  // 치료 정보
  treatment_info text
  common_medications json [note: '일반적으로 처방되는 약물']
  
  // 예방 및 관리
  prevention_tips json
  lifestyle_recommendations json
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    disease_name
    disease_code
    category
  }
  
  Note: 'MyDiseasesPage - 질병 정보 마스터 DB (ICD-10 기반)'
}

Table user_diseases {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  disease_id bigint [ref: > disease_info.id, not null]
  
  // 진단 정보
  diagnosed_date date
  diagnosed_by varchar(255) [note: '진단 의사/병원']
  diagnosis_notes text
  
  // 상태
  severity varchar(20) [note: '현재 질병 심각도']
  is_chronic boolean [default: false]
  is_active boolean [default: true]
  
  // 관리 정보
  treatment_plan text
  notes text [note: '사용자 메모']
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    disease_id
    (user_id, disease_id) [unique]
    is_active
  }
  
  Note: 'MyDiseasesPage - 사용자 진단 질병'
}

Table disease_restrictions {
  id bigint [pk, increment]
  disease_id bigint [ref: > disease_info.id, not null]
  
  // 제한 유형 및 대상
  restriction_type varchar(50) [not null, note: 'food | ingredient | medication | activity']
  restriction_name varchar(255) [not null]
  
  // 상세 정보
  reason text [not null, note: '제한 이유']
  severity varchar(20) [note: '높음 | 중간 | 낮음']
  
  // 권장사항
  alternatives json [note: '대체 가능한 항목']
  recommendations text
  
  // 출처
  source varchar(500)
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    disease_id
    restriction_type
    restriction_name
    (disease_id, restriction_type, restriction_name) [unique]
  }
  
  Note: 'DiseaseRestrictionsPage - 질병별 제한사항 (통합 테이블)'
}

// ================================================
// 7. 증상 검색 & AI 진단 (Symptom Search & AI Diagnosis)
// ================================================

Table symptom_searches {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  
  // 검색 입력
  search_query text [not null, note: '사용자가 입력한 증상 (자연어)']
  symptoms json [not null, note: '파싱된 증상 배열']
  
  // 추가 정보
  age int [note: '나이 (진단 정확도 향상)']
  gender varchar(10)
  duration_days int [note: '증상 지속 기간']
  severity_user_rated int [note: '1-10 사용자 평가']
  
  // AI 분석 결과
  ai_model varchar(100) [note: 'gpt-4, claude-3 등']
  ai_response_time_ms int
  
  searched_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    searched_at
  }
  
  Note: 'SymptomSearchPage - 증상 검색 이력'
}

Table suspected_diseases {
  id bigint [pk, increment]
  symptom_search_id bigint [ref: > symptom_searches.id, not null]
  disease_id bigint [ref: > disease_info.id, not null]
  
  // AI 분석 결과
  confidence_score decimal(5,2) [not null, note: 'AI 신뢰도 0.00~100.00%']
  match_reason text [note: 'AI 매칭 이유']
  matched_symptoms json [note: '매칭된 증상들']
  
  // 권장사항
  pharmacist_advice text [note: '약사 상담 권장 메시지']
  urgency_level varchar(20) [note: 'low | medium | high | emergency']
  recommendations text
  
  // 사용자 피드백
  user_agreed boolean [note: '사용자 동의 여부']
  user_feedback text
  
  created_at timestamp [default: `now()`]
  
  Indexes {
    symptom_search_id
    disease_id
    confidence_score
    urgency_level
    (symptom_search_id, confidence_score)
  }
  
  Note: 'SuspectedDiseasePage - AI 추천 의심 질병'
}

// ================================================
// 8. 약국 및 상담 (Pharmacy & Consultation)
// ================================================

Table pharmacies {
  id bigint [pk, increment]
  
  // 약국 정보
  pharmacy_name varchar(255) [not null]
  pharmacy_type varchar(50) [note: '일반약국 | 한방약국 | 병원약국']
  
  // 위치
  address text [not null]
  address_detail text
  city varchar(100)
  district varchar(100)
  postal_code varchar(20)
  
  // 좌표
  latitude decimal(10, 8) [not null]
  longitude decimal(11, 8) [not null]
  
  // 연락처
  phone varchar(20)
  fax varchar(20)
  email varchar(255)
  website text
  
  // 운영 정보
  business_hours json [note: '요일별 영업시간']
  is_24hours boolean [default: false]
  
  // 서비스
  has_consultation boolean [default: true]
  has_delivery boolean [default: false]
  has_parking boolean [default: false]
  
  // 평가
  rating decimal(3,2) [note: '평점 0.00-5.00']
  review_count int [default: 0]
  
  // 상태
  is_active boolean [default: true]
  verified_at timestamp
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    (latitude, longitude)
    city
    district
    pharmacy_name
    is_active
  }
  
  Note: 'PharmacyAdvicePage - 약국 정보 (근처 약국 찾기)'
}

Table counselors {
  id bigint [pk, increment]
  
  // 상담사 정보
  name varchar(100) [not null]
  type varchar(20) [not null, note: 'pharmacist | doctor | ai_bot']
  profile_image_url text
  introduction text
  
  // 전문가 정보 (type=pharmacist/doctor)
  pharmacy_id bigint [ref: > pharmacies.id, note: '소속 약국 (type=pharmacist)']
  hospital_name varchar(255)
  specialty varchar(100) [note: '전문 분야']
  license_number varchar(100) [unique, note: '면허번호']
  years_of_experience int
  
  // AI 챗봇 정보 (type=ai_bot)
  ai_model varchar(100) [note: 'gpt-4, claude-3 등']
  prompt_template text [note: 'System prompt']
  capabilities json [note: '가능한 상담 분야']
  
  // 상담 설정
  consultation_fee int [default: 0, note: '상담 비용 (0=무료)']
  average_response_time_minutes int
  
  // 통계
  total_consultations int [default: 0]
  average_rating decimal(3,2)
  
  // 상태
  is_online boolean [default: false]
  is_active boolean [default: true]
  last_active_at timestamp
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    type
    pharmacy_id
    specialty
    (type, is_active, is_online)
  }
  
  Note: 'PharmacistChatListPage - 약사/의사/AI 챗봇 정보'
}

Table chat_rooms {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  counselor_id bigint [ref: > counselors.id, not null]
  
  // 채팅방 정보
  room_name varchar(255) [note: '채팅방 이름 (선택)']
  room_type varchar(20) [default: 'consultation', note: 'consultation | support']
  
  // 상태
  status varchar(20) [default: 'active', note: 'active | archived | closed']
  closed_reason text
  
  // 마지막 메시지
  last_message_id bigint
  last_message_preview text [note: '마지막 메시지 미리보기']
  last_message_at timestamp
  
  // 읽지 않은 메시지
  unread_count_user int [default: 0]
  unread_count_counselor int [default: 0]
  
  // 평가
  rating int [note: '1-5점, 상담 종료 시 평가']
  feedback text
  rated_at timestamp
  
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  closed_at timestamp
  
  Indexes {
    user_id
    counselor_id
    (user_id, counselor_id) [unique]
    status
    last_message_at
  }
  
  Note: 'ChatConversationPage - 1:1 상담 채팅방'
}

Table chat_messages {
  id bigint [pk, increment]
  room_id bigint [ref: > chat_rooms.id, not null]
  
  // 발신자
  sender_id bigint [not null, note: 'user_id 또는 counselor_id']
  sender_type varchar(20) [not null, note: 'user | counselor']
  
  // 메시지 내용
  content text [not null]
  message_type varchar(20) [default: 'text', note: 'text | image | file | system']
  
  // 첨부파일
  attachments json [note: '{filename, url, size, type}[] 배열']
  
  // 읽음 상태
  is_read boolean [default: false]
  read_at timestamp
  
  // AI 응답 메타데이터 (sender_type=counselor, counselor.type=ai_bot)
  ai_model varchar(100)
  ai_confidence decimal(3,2) [note: 'AI 응답 신뢰도']
  ai_response_time_ms int
  
  // 상태
  is_deleted boolean [default: false]
  deleted_at timestamp
  
  created_at timestamp [default: `now()`]
  
  Indexes {
    room_id
    sender_id
    (room_id, created_at)
    is_read
    created_at
  }
  
  Note: 'ChatConversationPage - 채팅 메시지 (WebSocket 실시간 전송)'
}

// ================================================
// 9. OCR 처방전 스캔 (OCR Prescription Scan)
// ================================================

Table ocr_records {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  
  // 이미지 정보
  image_url text [not null, note: 'S3 저장 (24시간 후 삭제)']
  image_type varchar(50) [note: 'prescription | pill | package']
  image_size_bytes int
  
  // OCR 결과
  extracted_text text [note: '원본 텍스트 (전체)']
  parsed_data json [note: 'ParsedMedication 객체 배열']
  confidence_score decimal(3,2) [note: '전체 인식 신뢰도 0.00~1.00']
  
  // OCR 엔진
  ocr_engine varchar(50) [note: 'google-vision | tesseract']
  processing_time_ms int
  
  // 검증
  requires_manual_verification boolean [default: false, note: 'confidence < 0.85']
  manually_verified boolean [default: false]
  verified_at timestamp
  verified_by bigint [ref: > users.id, note: '검증한 사용자']
  
  // 수정 사항
  user_corrections json [note: '사용자가 수정한 내용']
  
  // 등록 연결
  medications_created int [default: 0, note: '생성된 약물 개수']
  
  // 에러 로그
  error_message text
  retry_count int [default: 0]
  
  created_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    (user_id, created_at)
    ocr_engine
    confidence_score
    manually_verified
  }
  
  Note: 'PrescriptionScanPage, OCRResultPage - OCR 처방전 인식 기록'
}

// ================================================
// 10. 알림 (Notifications)
// ================================================

Table notifications {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  
  // 알림 정보
  type varchar(50) [not null, note: 'medication_reminder | missed_dose | family_alert | diet_warning | chat_message | low_stock | expiring_soon']
  title varchar(255) [not null]
  message text [not null]
  
  // 우선순위
  priority varchar(20) [default: 'normal', note: 'low | normal | high | urgent']
  
  // 액션
  action_url text [note: '클릭 시 이동 경로']
  action_data json [note: '추가 데이터']
  action_buttons json [note: '액션 버튼 배열']
  
  // 관련 엔티티
  related_entity_type varchar(50) [note: 'medication | chat_room | diet_log | family_member']
  related_entity_id bigint
  
  // 상태
  is_read boolean [default: false]
  read_at timestamp
  
  // 발송 정보
  sent_via varchar(50) [default: 'web', note: 'web | kakao_alimtalk | push | sms | email']
  sent_at timestamp
  delivery_status varchar(20) [note: 'sent | delivered | failed']
  
  // 만료
  expires_at timestamp [note: '알림 자동 만료 시간']
  
  created_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    type
    (user_id, is_read, created_at)
    related_entity_type
    priority
    expires_at
  }
  
  Note: 'NotificationListPage, NotificationDetailPage - 사용자 알림'
}

// ================================================
// 11. 순응도 리포트 (Adherence Reports)
// ================================================

Table adherence_reports {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id, not null]
  family_group_id bigint [ref: > family_groups.id, note: '가족 그룹 리포트']
  
  // 보고서 정보
  report_type varchar(50) [default: 'personal', note: 'personal | family']
  title varchar(255)
  
  // 기간
  start_date date [not null]
  end_date date [not null]
  
  // 통계
  total_doses int [not null, note: '총 복용 예정 횟수']
  completed_doses int [not null, note: '완료한 복용']
  missed_doses int [not null, note: '놓친 복용']
  skipped_doses int [note: '건너뛴 복용']
  adherence_rate decimal(5,2) [note: '순응도 % (completed/total * 100)']
  
  // 약물별 상세
  medication_breakdown json [note: '약물별 순응도 배열 {med_id, name, rate, completed, total}']
  
  // 시간대별 분석
  morning_adherence decimal(5,2)
  afternoon_adherence decimal(5,2)
  evening_adherence decimal(5,2)
  night_adherence decimal(5,2)
  
  // 주간 트렌드
  weekly_trend json [note: '주별 순응도 그래프 데이터']
  
  // 문제 분석
  most_missed_medication_id bigint [ref: > medications.id]
  most_problematic_time varchar(50)
  
  // PDF 생성
  pdf_url text [note: 'S3 저장 경로']
  pdf_generated_at timestamp
  pdf_file_size_bytes int
  
  // 공유
  shared_with_doctor boolean [default: false]
  shared_at timestamp
  
  created_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    family_group_id
    (user_id, start_date, end_date)
    adherence_rate
  }
  
  Note: 'AdherenceReportPage - 복약 순응도 리포트 (PDF 다운로드)'
}

// ================================================
// 12. 감사 로그 (Audit Logs) - GDPR 준수
// ================================================

Table audit_logs {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id]
  
  // 액션 정보
  action varchar(100) [not null, note: 'create | read | update | delete | export']
  entity_type varchar(100) [not null, note: 'medication | user | family_member 등']
  entity_id bigint
  
  // 변경 내용
  old_value json [note: '변경 전 값']
  new_value json [note: '변경 후 값']
  changes_summary text [note: '변경 요약']
  
  // 요청 정보
  ip_address varchar(45)
  user_agent text
  device_id varchar(255)
  
  // 컨텍스트
  request_method varchar(10) [note: 'GET | POST | PUT | DELETE']
  request_path text
  response_status int
  
  // 보안 이벤트
  is_suspicious boolean [default: false]
  risk_level varchar(20) [note: 'low | medium | high']
  
  created_at timestamp [default: `now()`]
  
  Indexes {
    user_id
    entity_type
    created_at
    (entity_type, entity_id)
    action
    is_suspicious
  }
  
  Note: '민감정보 접근 감사 로그 (개인정보보호법, GDPR 준수)'
}

// ================================================
// 관계 정의 (Relationships)
// ================================================

// User relationships
Ref: oauth_providers.user_id > users.id [delete: cascade]
Ref: refresh_tokens.user_id > users.id [delete: cascade]

// Family relationships
Ref: family_groups.created_by > users.id
Ref: family_members.family_group_id > family_groups.id [delete: cascade]
Ref: family_members.user_id > users.id [delete: cascade]
Ref: family_members.invited_by > users.id

// Medication relationships
Ref: medications.user_id > users.id [delete: cascade]
Ref: medications.ocr_record_id > ocr_records.id
Ref: medication_schedules.medication_id > medications.id [delete: cascade]
Ref: medication_logs.medication_id > medications.id [delete: cascade]
Ref: medication_logs.user_id > users.id
Ref: medication_logs.schedule_id > medication_schedules.id
Ref: medication_logs.confirmed_by > users.id
Ref: medication_reviews.medication_id > medications.id [delete: cascade]
Ref: medication_reviews.user_id > users.id

// Diet relationships
Ref: diet_logs.user_id > users.id [delete: cascade]
Ref: diet_warnings.user_id > users.id [delete: cascade]
Ref: diet_warnings.diet_log_id > diet_logs.id [delete: cascade]
Ref: diet_warnings.medication_id > medications.id
Ref: diet_warnings.interaction_id > drug_food_interactions.id

// Disease relationships
Ref: user_diseases.user_id > users.id [delete: cascade]
Ref: user_diseases.disease_id > disease_info.id
Ref: disease_restrictions.disease_id > disease_info.id [delete: cascade]

// Symptom search relationships
Ref: symptom_searches.user_id > users.id [delete: cascade]
Ref: suspected_diseases.symptom_search_id > symptom_searches.id [delete: cascade]
Ref: suspected_diseases.disease_id > disease_info.id

// Pharmacy & Counselor relationships
Ref: counselors.pharmacy_id > pharmacies.id

// Chat relationships
Ref: chat_rooms.user_id > users.id [delete: cascade]
Ref: chat_rooms.counselor_id > counselors.id
Ref: chat_messages.room_id > chat_rooms.id [delete: cascade]

// OCR relationships
Ref: ocr_records.user_id > users.id [delete: cascade]
Ref: ocr_records.verified_by > users.id
Ref: ocr_records.medication_id > medications.id

// Notification relationships
Ref: notifications.user_id > users.id [delete: cascade]

// Report relationships
Ref: adherence_reports.user_id > users.id [delete: cascade]
Ref: adherence_reports.family_group_id > family_groups.id
Ref: adherence_reports.most_missed_medication_id > medications.id

// Audit log relationships
Ref: audit_logs.user_id > users.id

// ================================================
// 인덱스 전략 요약
// ================================================
// 1. 모든 FK에 인덱스
// 2. 자주 조회되는 컬럼 (email, kakao_id, phone 등)
// 3. 복합 인덱스 (user_id + 날짜/상태)
// 4. 검색용 인덱스 (name, title 등)
// 5. 시계열 데이터 (created_at, scheduled_time 등)

// ================================================
// 확장성 고려사항
// ================================================
// 1. Soft delete: is_active, deleted_at 필드 활용
// 2. 버전 관리: updated_at으로 동시성 제어 가능
// 3. Audit trail: audit_logs 테이블로 모든 변경 추적
// 4. Sharding 준비: user_id 기반 파티셔닝 가능
// 5. 캐싱: Redis로 자주 조회되는 데이터 캐시
// 6. 읽기 복제: 리포트 조회는 read replica 사용

// ================================================
// 보안 고려사항
// ================================================
// 1. 암호화: password_hash (BCrypt), tokens (AES-256)
// 2. 민감정보: audit_logs로 접근 추적
// 3. GDPR 준수: 개인정보 삭제 요청 처리 (cascade delete)
// 4. SQL Injection: Prepared Statement 사용
// 5. XSS: 프론트엔드에서 sanitization
